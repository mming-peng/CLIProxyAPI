# CLIProxyAPI å¼€å‘æŒ‡å—

## ç¯å¢ƒæ­å»º

### å‰ç½®è¦æ±‚

- **Go**: 1.24.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- **Git**: ç”¨äºç‰ˆæœ¬æ§åˆ¶
- **Docker** (å¯é€‰): ç”¨äºå®¹å™¨åŒ–éƒ¨ç½²

### å…‹éš†é¡¹ç›®

```bash
git clone https://github.com/router-for-me/CLIProxyAPI.git
cd CLIProxyAPI
```

### å®‰è£…ä¾èµ–

```bash
go mod download
```

### é…ç½®æ–‡ä»¶

å¤åˆ¶ç¤ºä¾‹é…ç½®æ–‡ä»¶å¹¶ä¿®æ”¹ï¼š

```bash
cp config.example.yaml config.yaml
```

ç¼–è¾‘ `config.yaml`ï¼Œè‡³å°‘é…ç½®ä»¥ä¸‹å†…å®¹ï¼š

```yaml
port: 8317
auth-dir: "~/.cli-proxy-api"
api-keys:
  - "your-api-key-here"
debug: true
```

## å¿«é€Ÿå¼€å§‹

### 1. è¿è¡ŒæœåŠ¡

```bash
go run cmd/server/main.go -config config.yaml
```

### 2. OAuth ç™»å½•ï¼ˆä»¥ OpenAI ä¸ºä¾‹ï¼‰

```bash
go run cmd/server/main.go -openai-login -config config.yaml
```

è¿™ä¼šæ‰“å¼€æµè§ˆå™¨å®Œæˆ OAuth è®¤è¯æµç¨‹ã€‚

### 3. æµ‹è¯• API

```bash
curl http://localhost:8317/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-api-key-here" \
  -d '{
    "model": "gpt-4",
    "messages": [{"role": "user", "content": "Hello!"}]
  }'
```

## å¼€å‘æµç¨‹

### é¡¹ç›®ç»“æ„å¯¼èˆª

```
CLIProxyAPI/
â”œâ”€â”€ cmd/server/         # åº”ç”¨ç¨‹åºå…¥å£
â”‚   â””â”€â”€ main.go        # ä¸»å‡½æ•°ï¼Œå¤„ç†å‘½ä»¤è¡Œå‚æ•°
â”œâ”€â”€ internal/          # å†…éƒ¨å®ç°ï¼ˆä¸å¯¼å‡ºï¼‰
â”‚   â”œâ”€â”€ api/          # HTTP API æœåŠ¡å™¨
â”‚   â”œâ”€â”€ auth/         # è®¤è¯æ¨¡å‹
â”‚   â”œâ”€â”€ translator/   # åè®®è½¬æ¢å™¨å®ç°
â”‚   â”œâ”€â”€ store/        # å­˜å‚¨å®ç°
â”‚   â””â”€â”€ ...
â”œâ”€â”€ sdk/              # å¯å¯¼å‡ºçš„ SDK
â”‚   â”œâ”€â”€ cliproxy/    # æ ¸å¿ƒæœåŠ¡ SDK
â”‚   â”œâ”€â”€ auth/        # è®¤è¯ SDK
â”‚   â”œâ”€â”€ translator/  # ç¿»è¯‘å™¨æ¡†æ¶
â”‚   â””â”€â”€ api/         # API å¤„ç†å™¨
â””â”€â”€ examples/        # ç¤ºä¾‹ä»£ç 
```

### å¼€å‘å·¥ä½œæµ

```mermaid
graph LR
    A[åˆ›å»ºåˆ†æ”¯] --> B[ç¼–å†™ä»£ç ]
    B --> C[å•å…ƒæµ‹è¯•]
    C --> D[æœ¬åœ°æµ‹è¯•]
    D --> E{æµ‹è¯•é€šè¿‡?}
    E -->|å¦| B
    E -->|æ˜¯| F[æäº¤ä»£ç ]
    F --> G[åˆ›å»º PR]
    G --> H[ä»£ç å®¡æŸ¥]
    H --> I{å®¡æŸ¥é€šè¿‡?}
    I -->|å¦| B
    I -->|æ˜¯| J[åˆå¹¶åˆ°ä¸»åˆ†æ”¯]
```

## æ ¸å¿ƒæ¨¡å—å¼€å‘

### 1. è‡ªå®šä¹‰ç¿»è¯‘å™¨

ç¿»è¯‘å™¨ç”¨äºåœ¨ä¸åŒ AI æœåŠ¡çš„è¯·æ±‚/å“åº”æ ¼å¼ä¹‹é—´è½¬æ¢ã€‚

#### æ­¥éª¤ 1: å®šä¹‰ç¿»è¯‘å™¨

```go
package mytranslator

import (
    "context"
    "encoding/json"
    
    "github.com/router-for-me/CLIProxyAPI/v6/sdk/translator"
)

// MyRequestTranslator å°†æºæ ¼å¼è½¬æ¢ä¸ºç›®æ ‡æ ¼å¼
type MyRequestTranslator struct{}

func (t *MyRequestTranslator) Translate(ctx context.Context, input []byte) ([]byte, error) {
    var sourceReq SourceRequest
    if err := json.Unmarshal(input, &sourceReq); err != nil {
        return nil, err
    }
    
    // æ‰§è¡Œè½¬æ¢é€»è¾‘
    targetReq := TargetRequest{
        Model: sourceReq.Model,
        // ... å…¶ä»–å­—æ®µæ˜ å°„
    }
    
    return json.Marshal(targetReq)
}

func (t *MyRequestTranslator) Protocol() translator.Protocol {
    return translator.Protocol{
        Input:  "source_protocol",
        Output: "target_protocol",
    }
}
```

#### æ­¥éª¤ 2: æ³¨å†Œç¿»è¯‘å™¨

```go
package mytranslator

import (
    "github.com/router-for-me/CLIProxyAPI/v6/sdk/translator"
)

func init() {
    translator.RegisterRequestTranslator(
        "source_protocol",
        "target_protocol",
        "endpoint_name",
        &MyRequestTranslator{},
    )
    
    translator.RegisterResponseTranslator(
        "target_protocol",
        "source_protocol",
        "endpoint_name",
        &MyResponseTranslator{},
    )
}
```

#### æ­¥éª¤ 3: å¯¼å…¥ç¿»è¯‘å™¨

åœ¨ `internal/translator/init.go` ä¸­æ·»åŠ ï¼š

```go
import (
    _ "github.com/router-for-me/CLIProxyAPI/v6/internal/translator/mytranslator"
)
```

### 2. è‡ªå®šä¹‰è®¤è¯å™¨

è®¤è¯å™¨ç”¨äºå®ç°ç‰¹å®š AI æœåŠ¡çš„ OAuth ç™»å½•æµç¨‹ã€‚

#### æ­¥éª¤ 1: å®ç° Authenticator æ¥å£

```go
package myauth

import (
    "context"
    
    "github.com/router-for-me/CLIProxyAPI/v6/internal/config"
    "github.com/router-for-me/CLIProxyAPI/v6/sdk/auth"
    coreauth "github.com/router-for-me/CLIProxyAPI/v6/sdk/cliproxy/auth"
)

type MyAuthenticator struct{}

func (a *MyAuthenticator) Provider() string {
    return "myprovider"
}

func (a *MyAuthenticator) Login(
    ctx context.Context,
    cfg *config.Config,
    opts *auth.LoginOptions,
) (*coreauth.Auth, error) {
    // å®ç° OAuth ç™»å½•æµç¨‹
    // 1. ç”Ÿæˆæˆæƒ URL
    // 2. æ‰“å¼€æµè§ˆå™¨
    // 3. ç­‰å¾…å›è°ƒ
    // 4. äº¤æ¢ access_token
    // 5. è¿”å› Auth å¯¹è±¡
    
    return &coreauth.Auth{
        ID:           "unique_id",
        Provider:     "myprovider",
        AccessToken:  "access_token",
        RefreshToken: "refresh_token",
        // ... å…¶ä»–å­—æ®µ
    }, nil
}
```

#### æ­¥éª¤ 2: æ³¨å†Œè®¤è¯å™¨

```go
func init() {
    defaultManager := auth.GetDefaultManager()
    defaultManager.Register(&MyAuthenticator{})
}
```

### 3. è‡ªå®šä¹‰å¤„ç†å™¨

è‡ªå®šä¹‰å¤„ç†å™¨ç”¨äºæ”¯æŒæ–°çš„ API ç«¯ç‚¹ã€‚

#### ç¤ºä¾‹: è‡ªå®šä¹‰æ¨¡å‹åˆ—è¡¨å¤„ç†å™¨

```go
package handlers

import (
    "net/http"
    
    "github.com/gin-gonic/gin"
    "github.com/router-for-me/CLIProxyAPI/v6/sdk/api/handlers"
)

func (h *BaseAPIHandler) HandleCustomModels(c *gin.Context) {
    models := h.GetAvailableModels()
    
    c.JSON(http.StatusOK, gin.H{
        "object": "list",
        "data":   models,
    })
}
```

#### æ³¨å†Œè·¯ç”±

åœ¨ `internal/api/server.go` çš„ `setupRoutes` æ–¹æ³•ä¸­ï¼š

```go
func (s *Server) setupRoutes() {
    // ... å…¶ä»–è·¯ç”±
    
    v1 := s.engine.Group("/v1")
    v1.GET("/custom/models", s.handlers.HandleCustomModels)
}
```

### 4. è‡ªå®šä¹‰å­˜å‚¨åç«¯

#### å®ç° Store æ¥å£

```go
package mystore

import (
    "context"
    
    coreauth "github.com/router-for-me/CLIProxyAPI/v6/sdk/cliproxy/auth"
)

type MyStore struct {
    // å­˜å‚¨é…ç½®
}

func (s *MyStore) Save(ctx context.Context, auth *coreauth.Auth) (string, error) {
    // ä¿å­˜è®¤è¯ä¿¡æ¯
    return "saved_path", nil
}

func (s *MyStore) Load(ctx context.Context) ([]*coreauth.Auth, error) {
    // åŠ è½½æ‰€æœ‰è®¤è¯ä¿¡æ¯
    return auths, nil
}

func (s *MyStore) Delete(ctx context.Context, id string) error {
    // åˆ é™¤è®¤è¯ä¿¡æ¯
    return nil
}

func (s *MyStore) LoadByID(ctx context.Context, id string) (*coreauth.Auth, error) {
    // æ ¹æ® ID åŠ è½½
    return auth, nil
}
```

#### ä½¿ç”¨è‡ªå®šä¹‰å­˜å‚¨

```go
import "github.com/router-for-me/CLIProxyAPI/v6/sdk/cliproxy"

store := &MyStore{}

service := cliproxy.NewBuilder().
    WithConfig(cfg).
    WithAuthManager(
        auth.NewManager(store),
    ).
    Build()
```

## æµ‹è¯•æŒ‡å—

### å•å…ƒæµ‹è¯•

#### æµ‹è¯•ç¿»è¯‘å™¨

```go
package mytranslator_test

import (
    "context"
    "testing"
    
    "github.com/router-for-me/CLIProxyAPI/v6/internal/translator/mytranslator"
)

func TestMyTranslator_Translate(t *testing.T) {
    translator := &mytranslator.MyRequestTranslator{}
    
    input := []byte(`{"model":"gpt-4","messages":[]}`)
    output, err := translator.Translate(context.Background(), input)
    
    if err != nil {
        t.Fatalf("unexpected error: %v", err)
    }
    
    // éªŒè¯è¾“å‡º
    // ...
}
```

#### è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
go test ./...

# è¿è¡Œç‰¹å®šåŒ…çš„æµ‹è¯•
go test ./internal/translator/...

# è¿è¡Œæµ‹è¯•å¹¶æ˜¾ç¤ºè¦†ç›–ç‡
go test -cover ./...

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
go test -coverprofile=coverage.out ./...
go tool cover -html=coverage.out
```

### é›†æˆæµ‹è¯•

åˆ›å»º `test/integration_test.go`:

```go
package test

import (
    "context"
    "net/http"
    "testing"
    
    "github.com/router-for-me/CLIProxyAPI/v6/internal/config"
    "github.com/router-for-me/CLIProxyAPI/v6/sdk/cliproxy"
)

func TestE2E_ChatCompletions(t *testing.T) {
    // 1. å¯åŠ¨æœåŠ¡
    cfg := &config.Config{
        Port: 18317,
        // ... é…ç½®
    }
    
    service, err := cliproxy.NewBuilder().
        WithConfig(cfg).
        WithConfigPath("test-config.yaml").
        Build()
    if err != nil {
        t.Fatal(err)
    }
    
    ctx, cancel := context.WithCancel(context.Background())
    defer cancel()
    
    go service.Run(ctx)
    
    // 2. å‘é€æµ‹è¯•è¯·æ±‚
    resp, err := http.Post(
        "http://localhost:18317/v1/chat/completions",
        "application/json",
        // ... è¯·æ±‚ä½“
    )
    
    // 3. éªŒè¯å“åº”
    if resp.StatusCode != http.StatusOK {
        t.Errorf("expected 200, got %d", resp.StatusCode)
    }
    
    // 4. å…³é—­æœåŠ¡
    service.Shutdown(context.Background())
}
```

## è°ƒè¯•æŠ€å·§

### 1. å¯ç”¨è°ƒè¯•æ—¥å¿—

åœ¨ `config.yaml` ä¸­è®¾ç½®ï¼š

```yaml
debug: true
logging-to-file: true
```

### 2. ä½¿ç”¨ VSCode è°ƒè¯•

åˆ›å»º `.vscode/launch.json`:

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Launch Server",
      "type": "go",
      "request": "launch",
      "mode": "auto",
      "program": "${workspaceFolder}/cmd/server",
      "args": ["-config", "config.yaml"],
      "env": {},
      "showLog": true
    }
  ]
}
```

### 3. æŸ¥çœ‹è¯·æ±‚/å“åº”æ—¥å¿—

æ—¥å¿—ä¼šè®°å½•æ‰€æœ‰è¯·æ±‚å’Œå“åº”çš„è¯¦ç»†ä¿¡æ¯ï¼š

```
INFO[0000] request started method=POST path=/v1/chat/completions
DEBUG[0000] request body: {"model":"gpt-4",...}
DEBUG[0001] response body: {"choices":[...],...}
INFO[0001] request completed status=200 latency=1.2s
```

### 4. ä½¿ç”¨ Postman/cURL æµ‹è¯•

```bash
# æµ‹è¯• OpenAI Chat Completions
curl -X POST http://localhost:8317/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-api-key" \
  -d @test-request.json

# æµ‹è¯•æµå¼å“åº”
curl -N -X POST http://localhost:8317/v1/chat/completions \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer your-api-key" \
  -d '{"model":"gpt-4","messages":[{"role":"user","content":"Hello"}],"stream":true}'
```

## æ€§èƒ½ä¼˜åŒ–

### 1. è¿æ¥æ± é…ç½®

```go
httpClient := &http.Client{
    Transport: &http.Transport{
        MaxIdleConns:        100,
        MaxIdleConnsPerHost: 10,
        IdleConnTimeout:     90 * time.Second,
    },
}
```

### 2. å¹¶å‘é™åˆ¶

ä½¿ç”¨ semaphore é™åˆ¶å¹¶å‘è¯·æ±‚æ•°ï¼š

```go
import "golang.org/x/sync/semaphore"

sem := semaphore.NewWeighted(10) // æœ€å¤š 10 ä¸ªå¹¶å‘è¯·æ±‚

func handleRequest(ctx context.Context) {
    if err := sem.Acquire(ctx, 1); err != nil {
        return err
    }
    defer sem.Release(1)
    
    // å¤„ç†è¯·æ±‚
}
```

### 3. ä½¿ç”¨ pprof æ€§èƒ½åˆ†æ

```go
import _ "net/http/pprof"

go func() {
    http.ListenAndServe("localhost:6060", nil)
}()
```

è®¿é—® `http://localhost:6060/debug/pprof/` æŸ¥çœ‹æ€§èƒ½åˆ†æã€‚

### 4. å†…å­˜ä¼˜åŒ–

- ä½¿ç”¨å¯¹è±¡æ± å‡å°‘å†…å­˜åˆ†é…
- åŠæ—¶å…³é—­å“åº”ä½“
- é¿å…ä¸å¿…è¦çš„æ•°æ®å¤åˆ¶

```go
var bufferPool = sync.Pool{
    New: func() interface{} {
        return new(bytes.Buffer)
    },
}

buf := bufferPool.Get().(*bytes.Buffer)
defer bufferPool.Put(buf)
```

## å®‰å…¨å®è·µ

### 1. API Key å®‰å…¨

```yaml
# ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç  API Key
# ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶
api-keys:
  - ${API_KEY_1}
  - ${API_KEY_2}
```

### 2. Token å­˜å‚¨

ç¡®ä¿ token æ–‡ä»¶æƒé™æ­£ç¡®ï¼š

```bash
chmod 600 ~/.cli-proxy-api/*/account*.json
```

### 3. HTTPS éƒ¨ç½²

åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯ç”¨ TLSï¼š

```yaml
tls:
  enable: true
  cert: "/path/to/cert.pem"
  key: "/path/to/key.pem"
```

### 4. ç®¡ç† API å®‰å…¨

```yaml
remote-management:
  allow-remote: false  # ä»…å…è®¸ localhost
  secret-key: "strong-secret-key"  # ä½¿ç”¨å¼ºå¯†é’¥
```

## å‘å¸ƒæµç¨‹

### 1. ç‰ˆæœ¬æ ‡è®°

```bash
git tag v6.1.0
git push origin v6.1.0
```

### 2. æ„å»ºäºŒè¿›åˆ¶

ä½¿ç”¨ GoReleaser:

```bash
goreleaser release --clean
```

### 3. Docker é•œåƒ

```bash
# æ„å»ºé•œåƒ
docker build -t cliproxy-api:v6.1.0 .

# æ¨é€åˆ° Docker Hub
docker push cliproxy-api:v6.1.0
```

### 4. å‘å¸ƒè¯´æ˜

åœ¨ GitHub Releases ä¸­æ·»åŠ å‘å¸ƒè¯´æ˜ï¼š

- æ–°åŠŸèƒ½
- Bug ä¿®å¤
- ç ´åæ€§å˜æ›´
- å‡çº§æŒ‡å—

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•æ·»åŠ æ–°çš„ AI æœåŠ¡æä¾›å•†ï¼Ÿ

A: éœ€è¦å®ç°ä»¥ä¸‹ç»„ä»¶ï¼š

1. **è®¤è¯å™¨** (`sdk/auth/`)ï¼šå®ç° OAuth ç™»å½•æµç¨‹
2. **ç¿»è¯‘å™¨** (`internal/translator/`)ï¼šå®ç°è¯·æ±‚/å“åº”è½¬æ¢
3. **æ³¨å†Œè®¤è¯å™¨**ï¼šåœ¨ `sdk/cliproxy/service.go` ä¸­æ³¨å†Œ

### Q2: å¦‚ä½•è°ƒè¯•ç¿»è¯‘å™¨é—®é¢˜ï¼Ÿ

A: 

1. å¯ç”¨ debug æ—¥å¿—æŸ¥çœ‹è¯·æ±‚/å“åº”
2. åœ¨ç¿»è¯‘å™¨ä¸­æ·»åŠ æ—¥å¿—è¾“å‡º
3. ä½¿ç”¨å•å…ƒæµ‹è¯•éªŒè¯è½¬æ¢é€»è¾‘

### Q3: å¦‚ä½•å¤„ç†é€Ÿç‡é™åˆ¶ï¼Ÿ

A:

1. é…ç½®å¤šä¸ªè´¦æˆ·è¿›è¡Œè´Ÿè½½å‡è¡¡
2. å¯ç”¨è‡ªåŠ¨é‡è¯•æœºåˆ¶
3. è°ƒæ•´ `request-retry` å’Œ `max-retry-interval`

### Q4: å¦‚ä½•é›†æˆåˆ°ç°æœ‰é¡¹ç›®ï¼Ÿ

A:

ä½¿ç”¨ SDK:

```go
import "github.com/router-for-me/CLIProxyAPI/v6/sdk/cliproxy"

service := cliproxy.NewBuilder().
    WithConfig(cfg).
    WithConfigPath(path).
    Build()

service.Run(ctx)
```

### Q5: å¦‚ä½•è´¡çŒ®ä»£ç ï¼Ÿ

A:

1. Fork ä»“åº“
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. ç¼–å†™ä»£ç å’Œæµ‹è¯•
4. æäº¤ Pull Request
5. ç­‰å¾…ä»£ç å®¡æŸ¥

## å¼€å‘å·¥å…·æ¨è

### IDE
- **VSCode** + Go æ‰©å±•
- **GoLand**

### API æµ‹è¯•
- **Postman**
- **Insomnia**
- **cURL**

### è°ƒè¯•å·¥å…·
- **Delve** (Go è°ƒè¯•å™¨)
- **pprof** (æ€§èƒ½åˆ†æ)

### Git å·¥å…·
- **Git CLI**
- **GitHub Desktop**
- **Fork**

## èµ„æºé“¾æ¥

- **é¡¹ç›®ä¸»é¡µ**: https://github.com/router-for-me/CLIProxyAPI
- **æ–‡æ¡£**: https://help.router-for.me/
- **SDK æ–‡æ¡£**: 
  - [SDK ä½¿ç”¨æ–‡æ¡£](../docs/sdk-usage_CN.md)
  - [SDK é«˜çº§åŠŸèƒ½](../docs/sdk-advanced_CN.md)
  - [è®¤è¯æ–‡æ¡£](../docs/sdk-access_CN.md)
- **ç¤¾åŒº**:
  - QQ ç¾¤: 188637136
  - Telegram: https://t.me/CLIProxyAPI

## è´¡çŒ®è€…æŒ‡å—

### ä»£ç è§„èŒƒ

1. **éµå¾ª Go ä»£ç è§„èŒƒ**: ä½¿ç”¨ `gofmt` æ ¼å¼åŒ–ä»£ç 
2. **æ·»åŠ æ³¨é‡Š**: ä¸ºå¯¼å‡ºçš„å‡½æ•°å’Œç±»å‹æ·»åŠ æ–‡æ¡£æ³¨é‡Š
3. **é”™è¯¯å¤„ç†**: æ˜ç¡®å¤„ç†æ‰€æœ‰é”™è¯¯ï¼Œä¸è¦å¿½ç•¥
4. **æµ‹è¯•è¦†ç›–**: ä¸ºæ–°åŠŸèƒ½ç¼–å†™å•å…ƒæµ‹è¯•

### æäº¤æ¶ˆæ¯è§„èŒƒ

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type**:
- `feat`: æ–°åŠŸèƒ½
- `fix`: Bug ä¿®å¤
- `docs`: æ–‡æ¡£æ›´æ–°
- `style`: ä»£ç æ ¼å¼åŒ–
- `refactor`: é‡æ„
- `test`: æµ‹è¯•ç›¸å…³
- `chore`: æ„å»º/å·¥å…·ç›¸å…³

**ç¤ºä¾‹**:
```
feat(translator): add support for new AI provider

Implemented request and response translators for XYZ provider.
Added unit tests and integration tests.

Closes #123
```

---

**ç¥å¼€å‘æ„‰å¿«ï¼** ğŸš€
